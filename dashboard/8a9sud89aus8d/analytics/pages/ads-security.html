<div class="header">
  <h2><span class="service-badge ads">ADS</span> Security Ads Analysis</h2>
  <div class="header-actions">
    <div class="date-filter" style="display: flex; align-items: center; gap: 8px;">
      <select id="ads-security-period" onchange="onPeriodChange('ads-security')" style="font-size: 12px;">
        <option value="7">7 dias</option>
        <option value="14">14 dias</option>
        <option value="30" selected>30 dias</option>
        <option value="60">60 dias</option>
        <option value="90">90 dias</option>
        <option value="custom">Custom</option>
      </select>
      <div class="date-range-inputs" id="ads-security-custom-dates" style="display: flex; align-items: center; gap: 4px;">
        <input type="date" id="ads-security-start-date" onchange="onCustomDateChange('ads-security')" style="font-size: 11px; padding: 4px 6px;">
        <span style="color: #64748b; font-size: 11px;">ate</span>
        <input type="date" id="ads-security-end-date" onchange="onCustomDateChange('ads-security')" style="font-size: 11px; padding: 4px 6px;">
      </div>
    </div>
    <button class="refresh-btn" onclick="loadProjectPage('ads-security')">Atualizar</button>
  </div>
</div>

<!-- ============================================================================= -->
<!-- OVERVIEW - KPIs principais dos anuncios -->
<!-- ============================================================================= -->
<div class="cards">
  <div class="card highlight">
    <div class="card-title">Gasto Total <span class="info-tooltip" data-tooltip="Total investido em anuncios no periodo selecionado."></span></div>
    <div class="card-value" id="ads-total-spend">R$ --</div>
    <div class="card-subtitle">Investimento</div>
  </div>
  <div class="card">
    <div class="card-title">Impressoes <span class="info-tooltip" data-tooltip="Numero total de vezes que os anuncios foram exibidos."></span></div>
    <div class="card-value" id="ads-total-impressions">--</div>
    <div class="card-subtitle">Exibicoes</div>
  </div>
  <div class="card">
    <div class="card-title">Cliques <span class="info-tooltip" data-tooltip="Total de cliques nos anuncios."></span></div>
    <div class="card-value" id="ads-total-clicks">--</div>
    <div class="card-subtitle">Interacoes</div>
  </div>
  <div class="card">
    <div class="card-title">Leads <span class="info-tooltip tooltip-left" data-tooltip="Total de conversoes/leads gerados pelos anuncios."></span></div>
    <div class="card-value" id="ads-total-leads" style="color: #22c55e;">--</div>
    <div class="card-subtitle">Conversoes</div>
  </div>
</div>

<!-- ============================================================================= -->
<!-- METRICAS CHAVE - CTR, CPC, CPL -->
<!-- ============================================================================= -->
<div class="cards">
  <div class="card">
    <div class="card-title">CTR <span class="info-tooltip" data-tooltip="Click-Through Rate - Taxa de cliques. Cliques / Impressoes."></span></div>
    <div class="card-value" id="ads-ctr">--%</div>
    <div class="card-subtitle">Taxa de cliques</div>
  </div>
  <div class="card">
    <div class="card-title">CPC <span class="info-tooltip" data-tooltip="Custo Por Clique - Quanto paga por cada clique."></span></div>
    <div class="card-value" id="ads-cpc">R$ --</div>
    <div class="card-subtitle">Custo por clique</div>
  </div>
  <div class="card">
    <div class="card-title">CPM <span class="info-tooltip" data-tooltip="Custo Por Mil impressoes."></span></div>
    <div class="card-value" id="ads-cpm">R$ --</div>
    <div class="card-subtitle">Custo por 1000 imp</div>
  </div>
  <div class="card highlight">
    <div class="card-title">CPL <span class="info-tooltip tooltip-left" data-tooltip="Custo Por Lead - Metrica mais importante! Quanto paga por cada lead."></span></div>
    <div class="card-value" id="ads-cpl" style="color: #f59e0b;">R$ --</div>
    <div class="card-subtitle">Custo por lead</div>
  </div>
</div>

<!-- ============================================================================= -->
<!-- STATUS DOS ANUNCIOS - Visao rapida da saude -->
<!-- ============================================================================= -->
<div class="section">
  <div class="section-title">Status dos Anuncios <span class="info-tooltip" data-tooltip="Distribuicao dos anuncios por status do Auto-Optimizer."></span></div>

  <div class="cards" style="grid-template-columns: repeat(6, 1fr);">
    <div class="card" style="border-left: 3px solid #3b82f6;">
      <div class="card-title" style="font-size: 11px;">Learning</div>
      <div class="card-value" id="ads-status-learning" style="font-size: 24px;">--</div>
    </div>
    <div class="card" style="border-left: 3px solid #22c55e;">
      <div class="card-title" style="font-size: 11px;">Healthy</div>
      <div class="card-value" id="ads-status-healthy" style="font-size: 24px; color: #22c55e;">--</div>
    </div>
    <div class="card" style="border-left: 3px solid #f59e0b;">
      <div class="card-title" style="font-size: 11px;">Warning</div>
      <div class="card-value" id="ads-status-warning" style="font-size: 24px; color: #f59e0b;">--</div>
    </div>
    <div class="card" style="border-left: 3px solid #ef4444;">
      <div class="card-title" style="font-size: 11px;">Critical</div>
      <div class="card-value" id="ads-status-critical" style="font-size: 24px; color: #ef4444;">--</div>
    </div>
    <div class="card" style="border-left: 3px solid #8b5cf6;">
      <div class="card-title" style="font-size: 11px;">Scaling</div>
      <div class="card-value" id="ads-status-scaling" style="font-size: 24px; color: #8b5cf6;">--</div>
    </div>
    <div class="card" style="border-left: 3px solid #6b7280;">
      <div class="card-title" style="font-size: 11px;">Paused</div>
      <div class="card-value" id="ads-status-paused" style="font-size: 24px; color: #6b7280;">--</div>
    </div>
  </div>
</div>

<!-- ============================================================================= -->
<!-- RECOMENDACOES DO AUTO-OPTIMIZER -->
<!-- ============================================================================= -->
<div class="section">
  <div class="section-title" style="display: flex; align-items: center; gap: 12px;">
    <span>Recomendacoes</span>
    <span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;" id="ads-recommendations-high">0</span>
    <span style="font-size: 12px; color: #94a3b8;">acoes prioritarias</span>
    <span class="info-tooltip" data-tooltip="Recomendacoes do Auto-Optimizer baseadas nas regras de Stop Loss, Accelerator e Explorer."></span>
  </div>

  <div id="ads-recommendations-list" style="max-height: 400px; overflow-y: auto;">
    <div style="color: #64748b; text-align: center; padding: 40px;">Carregando recomendacoes...</div>
  </div>
</div>

<!-- ============================================================================= -->
<!-- GRAFICO DE PERFORMANCE DIARIA -->
<!-- ============================================================================= -->
<div class="section">
  <div class="section-title">Performance Diaria <span class="info-tooltip" data-tooltip="Evolucao do gasto, cliques e leads por dia."></span></div>
  <div id="ads-daily-chart" style="height: 280px;"></div>
</div>

<!-- ============================================================================= -->
<!-- TABELA DE ANUNCIOS -->
<!-- ============================================================================= -->
<div class="section">
  <div class="section-title" style="display: flex; align-items: center; justify-content: space-between;">
    <div style="display: flex; align-items: center; gap: 12px;">
      <span>Todos os Anuncios</span>
      <span style="background: #334155; padding: 2px 8px; border-radius: 4px; font-size: 12px;" id="ads-total-count">0</span>
      <span class="info-tooltip" data-tooltip="Lista de todos os anuncios ativos na campanha com metricas detalhadas."></span>
    </div>
    <div style="display: flex; gap: 8px;">
      <select id="ads-filter-status" onchange="filterAdsTable()" style="font-size: 12px; padding: 4px 8px;">
        <option value="">Todos Status</option>
        <option value="LEARNING">Learning</option>
        <option value="HEALTHY">Healthy</option>
        <option value="WARNING">Warning</option>
        <option value="CRITICAL">Critical</option>
        <option value="SCALING">Scaling</option>
        <option value="PAUSED">Paused</option>
      </select>
      <button class="refresh-btn" onclick="loadAdsData()">Atualizar</button>
    </div>
  </div>

  <!-- Filtros Avancados -->
  <div id="ads-advanced-filters" style="background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
      <span style="font-size: 13px; font-weight: 600; color: #94a3b8;">Filtros Avancados</span>
      <button onclick="clearAdvancedFilters()" style="font-size: 11px; padding: 4px 8px; background: #334155; border: none; border-radius: 4px; color: #94a3b8; cursor: pointer;">Limpar Filtros</button>
    </div>
    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px;">
      <!-- Gasto -->
      <div>
        <label style="font-size: 11px; color: #64748b; display: block; margin-bottom: 4px;">Gasto (R$)</label>
        <div style="display: flex; gap: 4px;">
          <input type="number" id="filter-spend-min" placeholder="Min" onchange="applyAdvancedFilters()" style="width: 100%; font-size: 11px; padding: 4px 6px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
          <input type="number" id="filter-spend-max" placeholder="Max" onchange="applyAdvancedFilters()" style="width: 100%; font-size: 11px; padding: 4px 6px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
        </div>
      </div>
      <!-- Impressoes -->
      <div>
        <label style="font-size: 11px; color: #64748b; display: block; margin-bottom: 4px;">Impressoes</label>
        <div style="display: flex; gap: 4px;">
          <input type="number" id="filter-impressions-min" placeholder="Min" onchange="applyAdvancedFilters()" style="width: 100%; font-size: 11px; padding: 4px 6px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
          <input type="number" id="filter-impressions-max" placeholder="Max" onchange="applyAdvancedFilters()" style="width: 100%; font-size: 11px; padding: 4px 6px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
        </div>
      </div>
      <!-- Cliques -->
      <div>
        <label style="font-size: 11px; color: #64748b; display: block; margin-bottom: 4px;">Cliques</label>
        <div style="display: flex; gap: 4px;">
          <input type="number" id="filter-clicks-min" placeholder="Min" onchange="applyAdvancedFilters()" style="width: 100%; font-size: 11px; padding: 4px 6px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
          <input type="number" id="filter-clicks-max" placeholder="Max" onchange="applyAdvancedFilters()" style="width: 100%; font-size: 11px; padding: 4px 6px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
        </div>
      </div>
      <!-- CTR -->
      <div>
        <label style="font-size: 11px; color: #64748b; display: block; margin-bottom: 4px;">CTR (%)</label>
        <div style="display: flex; gap: 4px;">
          <input type="number" step="0.1" id="filter-ctr-min" placeholder="Min" onchange="applyAdvancedFilters()" style="width: 100%; font-size: 11px; padding: 4px 6px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
          <input type="number" step="0.1" id="filter-ctr-max" placeholder="Max" onchange="applyAdvancedFilters()" style="width: 100%; font-size: 11px; padding: 4px 6px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
        </div>
      </div>
      <!-- CPC -->
      <div>
        <label style="font-size: 11px; color: #64748b; display: block; margin-bottom: 4px;">CPC (R$)</label>
        <div style="display: flex; gap: 4px;">
          <input type="number" step="0.01" id="filter-cpc-min" placeholder="Min" onchange="applyAdvancedFilters()" style="width: 100%; font-size: 11px; padding: 4px 6px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
          <input type="number" step="0.01" id="filter-cpc-max" placeholder="Max" onchange="applyAdvancedFilters()" style="width: 100%; font-size: 11px; padding: 4px 6px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
        </div>
      </div>
      <!-- Pontuacao -->
      <div>
        <label style="font-size: 11px; color: #64748b; display: block; margin-bottom: 4px;">Pontuacao</label>
        <div style="display: flex; gap: 4px;">
          <input type="number" id="filter-score-min" placeholder="Min" onchange="applyAdvancedFilters()" style="width: 100%; font-size: 11px; padding: 4px 6px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
          <input type="number" id="filter-score-max" placeholder="Max" onchange="applyAdvancedFilters()" style="width: 100%; font-size: 11px; padding: 4px 6px; background: #0f172a; border: 1px solid #334155; border-radius: 4px; color: #f1f5f9;">
        </div>
      </div>
    </div>
    <div style="margin-top: 8px; font-size: 11px; color: #64748b;" id="filter-results-count"></div>
  </div>

  <div class="table-container" style="overflow-x: auto;">
    <table id="ads-table-container" class="table-resizable">
      <thead>
        <tr>
          <th class="sortable-header" onclick="handleAdsSort('status')" style="width: 90px;">Status</th>
          <th class="sortable-header" onclick="handleAdsSort('name')" style="width: 200px;">Nome</th>
          <th style="width: 120px;">Targeting</th>
          <th style="width: 100px;">Destino</th>
          <th style="width: 160px;">Origem (UTM)</th>
          <th class="sortable-header" onclick="handleAdsSort('spend')" style="width: 80px;">Gasto</th>
          <th class="sortable-header" onclick="handleAdsSort('impressions')" style="width: 90px;">Impressoes</th>
          <th class="sortable-header" onclick="handleAdsSort('clicks')" style="width: 70px;">Cliques</th>
          <th class="sortable-header" onclick="handleAdsSort('ctr')" style="width: 60px;">CTR</th>
          <th class="sortable-header" onclick="handleAdsSort('cpc')" style="width: 70px;">CPC</th>
          <th class="sortable-header" onclick="handleAdsSort('leads')" style="width: 60px;">Leads</th>
          <th class="sortable-header" onclick="handleAdsSort('cpl')" style="width: 70px;">CPL</th>
          <th class="sortable-header" onclick="handleAdsSort('score')" style="width: 80px;">Pontuacao</th>
          <th style="width: 80px;">Analise</th>
          <th style="width: 120px;">Recomendacao</th>
        </tr>
      </thead>
      <tbody id="ads-table">
        <tr><td colspan="15" class="loading">Carregando...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ============================================================================= -->
<!-- UTM BREAKDOWN - Origem do Tráfego -->
<!-- ============================================================================= -->
<div class="section">
  <div class="section-title">Origem do Tráfego (UTM Params) <span class="info-tooltip" data-tooltip="Valores únicos de UTM params detectados nos eventos de analytics."></span></div>

  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px;">
    <!-- UTM Source -->
    <div style="background: #1e293b; padding: 16px; border-radius: 12px;">
      <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px; font-weight: 600;">UTM SOURCE</div>
      <div id="utm-sources-list" style="font-size: 12px; max-height: 200px; overflow-y: auto;">
        <div style="color: #64748b;">Carregando...</div>
      </div>
    </div>

    <!-- UTM Medium -->
    <div style="background: #1e293b; padding: 16px; border-radius: 12px;">
      <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px; font-weight: 600;">UTM MEDIUM</div>
      <div id="utm-mediums-list" style="font-size: 12px; max-height: 200px; overflow-y: auto;">
        <div style="color: #64748b;">Carregando...</div>
      </div>
    </div>

    <!-- UTM Campaign -->
    <div style="background: #1e293b; padding: 16px; border-radius: 12px;">
      <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px; font-weight: 600;">UTM CAMPAIGN</div>
      <div id="utm-campaigns-list" style="font-size: 12px; max-height: 200px; overflow-y: auto;">
        <div style="color: #64748b;">Carregando...</div>
      </div>
    </div>

    <!-- UTM Content -->
    <div style="background: #1e293b; padding: 16px; border-radius: 12px;">
      <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px; font-weight: 600;">UTM CONTENT</div>
      <div id="utm-contents-list" style="font-size: 12px; max-height: 200px; overflow-y: auto;">
        <div style="color: #64748b;">Carregando...</div>
      </div>
    </div>
  </div>

  <!-- Tabela completa de combinações -->
  <div class="table-container" style="max-height: 300px; overflow-y: auto;">
    <table>
      <thead>
        <tr>
          <th>Source</th>
          <th>Medium</th>
          <th>Campaign</th>
          <th>Content</th>
          <th>Sessões</th>
          <th>Page Views</th>
          <th>Form Submits</th>
          <th>Conversões</th>
        </tr>
      </thead>
      <tbody id="utm-breakdown-table">
        <tr><td colspan="8" style="text-align: center; color: #64748b;">Carregando...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ============================================================================= -->
<!-- CAMPANHAS -->
<!-- ============================================================================= -->
<div class="section">
  <div class="section-title">Campanhas <span class="info-tooltip" data-tooltip="Lista de campanhas da conta de anuncios."></span></div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Status</th>
          <th>Objetivo</th>
          <th>Budget Diario</th>
          <th>Budget Restante</th>
          <th>Criado em</th>
        </tr>
      </thead>
      <tbody id="ads-campaigns-table">
        <tr><td colspan="6" class="loading">Carregando...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ============================================================================= -->
<!-- REGRAS DO AUTO-OPTIMIZER (referencia) -->
<!-- ============================================================================= -->
<details class="section" style="cursor: pointer;">
  <summary class="section-title" style="list-style: none; display: flex; align-items: center; gap: 8px;">
    <span style="transition: transform 0.2s;">&#9654;</span>
    <span>Regras do Auto-Optimizer</span>
    <span style="font-size: 12px; color: #64748b; font-weight: normal;">— clique para expandir</span>
  </summary>

  <div style="margin-top: 16px;">
    <div class="grid-3" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
      <!-- Stop Loss -->
      <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 16px;">
        <div style="font-size: 14px; font-weight: 600; color: #ef4444; margin-bottom: 12px;">Stop Loss</div>
        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">Pausar anuncios com baixa performance</div>
        <div style="font-size: 11px; color: #64748b;">
          <div style="margin-bottom: 4px;">• CTR < 0.5% apos 1.000 imp</div>
          <div style="margin-bottom: 4px;">• CPL > 3x media da campanha</div>
          <div style="margin-bottom: 4px;">• Gasto > R$50 sem conversao</div>
        </div>
      </div>

      <!-- Accelerator -->
      <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 16px;">
        <div style="font-size: 14px; font-weight: 600; color: #8b5cf6; margin-bottom: 12px;">Accelerator</div>
        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">Escalar anuncios de alta performance</div>
        <div style="font-size: 11px; color: #64748b;">
          <div style="margin-bottom: 4px;">• CTR > 2%</div>
          <div style="margin-bottom: 4px;">• CPL < 0.5x media da campanha</div>
          <div style="margin-bottom: 4px;">• ROAS > 3x</div>
          <div style="margin-bottom: 4px;">• Min 5 conversoes</div>
        </div>
      </div>

      <!-- Explorer -->
      <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 16px;">
        <div style="font-size: 14px; font-weight: 600; color: #3b82f6; margin-bottom: 12px;">Explorer</div>
        <div style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">Monitorar anuncios em aprendizado</div>
        <div style="font-size: 11px; color: #64748b;">
          <div style="margin-bottom: 4px;">• < 500 impressoes</div>
          <div style="margin-bottom: 4px;">• < 3 dias ativo</div>
          <div style="margin-bottom: 4px;">• Aguardando dados</div>
        </div>
      </div>
    </div>

    <div style="margin-top: 16px; padding: 12px; background: #1e293b; border-radius: 8px;">
      <div style="font-size: 12px; font-weight: 600; color: #f1f5f9; margin-bottom: 8px;">Legenda de Status</div>
      <div style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 11px;">
        <div style="display: flex; align-items: center; gap: 4px;">
          <span style="width: 12px; height: 12px; border-radius: 2px; background: #3b82f6;"></span>
          <span style="color: #94a3b8;">LEARNING - Coletando dados</span>
        </div>
        <div style="display: flex; align-items: center; gap: 4px;">
          <span style="width: 12px; height: 12px; border-radius: 2px; background: #22c55e;"></span>
          <span style="color: #94a3b8;">HEALTHY - Desempenho OK</span>
        </div>
        <div style="display: flex; align-items: center; gap: 4px;">
          <span style="width: 12px; height: 12px; border-radius: 2px; background: #f59e0b;"></span>
          <span style="color: #94a3b8;">WARNING - Atencao necessaria</span>
        </div>
        <div style="display: flex; align-items: center; gap: 4px;">
          <span style="width: 12px; height: 12px; border-radius: 2px; background: #ef4444;"></span>
          <span style="color: #94a3b8;">CRITICAL - Considerar pausar</span>
        </div>
        <div style="display: flex; align-items: center; gap: 4px;">
          <span style="width: 12px; height: 12px; border-radius: 2px; background: #8b5cf6;"></span>
          <span style="color: #94a3b8;">SCALING - Candidato a escala</span>
        </div>
        <div style="display: flex; align-items: center; gap: 4px;">
          <span style="width: 12px; height: 12px; border-radius: 2px; background: #6b7280;"></span>
          <span style="color: #94a3b8;">PAUSED - Pausado</span>
        </div>
      </div>
    </div>
  </div>
</details>

<!-- ============================================================================= -->
<!-- ANALYTICS - FUNIL DO GA4 -->
<!-- ============================================================================= -->
<div class="section">
  <div class="section-title" style="display: flex; align-items: center; gap: 12px;">
    <span>Analytics - Funil de Conversao</span>
    <span class="info-tooltip" data-tooltip="Dados do Google Analytics 4 mostrando o funil de conversao do /scan."></span>
    <button class="refresh-btn" style="margin-left: auto;" onclick="forceGA4Sync()">Sincronizar</button>
  </div>

  <!-- Metricas de Sessao -->
  <div class="cards" style="margin-bottom: 16px;">
    <div class="card">
      <div class="card-title">Usuarios Ativos <span class="info-tooltip" data-tooltip="Usuarios unicos que visitaram o site nos ultimos 7 dias."></span></div>
      <div class="card-value" id="ga4-active-users">--</div>
      <div class="card-subtitle">7 dias</div>
    </div>
    <div class="card">
      <div class="card-title">Sessoes <span class="info-tooltip" data-tooltip="Total de sessoes no periodo."></span></div>
      <div class="card-value" id="ga4-sessions">--</div>
      <div class="card-subtitle">7 dias</div>
    </div>
    <div class="card">
      <div class="card-title">Page Views <span class="info-tooltip" data-tooltip="Total de visualizacoes de pagina."></span></div>
      <div class="card-value" id="ga4-page-views">--</div>
      <div class="card-subtitle">7 dias</div>
    </div>
    <div class="card">
      <div class="card-title">Bounce Rate <span class="info-tooltip tooltip-left" data-tooltip="Taxa de rejeicao - usuarios que sairam sem interagir."></span></div>
      <div class="card-value" id="ga4-bounce-rate">--%</div>
      <div class="card-subtitle">7 dias</div>
    </div>
  </div>

  <!-- Funil Visual -->
  <div style="background: #1e293b; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
    <div style="font-size: 14px; font-weight: 600; color: #f1f5f9; margin-bottom: 16px;">Funil: Scan Flow</div>
    <div id="ga4-funnel-container" style="display: flex; flex-direction: column; gap: 8px;">
      <div style="color: #64748b; text-align: center; padding: 20px;">Carregando funil...</div>
    </div>
  </div>

  <!-- Top Eventos -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
    <div style="background: #1e293b; border-radius: 8px; padding: 16px;">
      <div style="font-size: 14px; font-weight: 600; color: #f1f5f9; margin-bottom: 12px;">Top Eventos (7 dias)</div>
      <div id="ga4-top-events" style="font-size: 12px;">
        <div style="color: #64748b;">Carregando...</div>
      </div>
    </div>
    <div style="background: #1e293b; border-radius: 8px; padding: 16px;">
      <div style="font-size: 14px; font-weight: 600; color: #f1f5f9; margin-bottom: 12px;">Top Paginas (7 dias)</div>
      <div id="ga4-top-pages" style="font-size: 12px;">
        <div style="color: #64748b;">Carregando...</div>
      </div>
    </div>
  </div>
</div>

<script>
// GA4 Analytics Functions - Consumindo do Cache Local
async function loadGA4Analytics() {
  try {
    // Carregar do cache local (syncronizado periodicamente)
    const [sessionData, funnelData, eventsData, pagesData] = await Promise.all([
      fetchFromCache('ga4', 'session_metrics', 7),
      fetchFromCache('ga4', 'funnel_scan', 30),
      fetchFromCache('ga4', 'events', 7),
      fetchFromCache('ga4', 'pages', 7)
    ]);

    if (sessionData) updateGA4SessionMetrics(sessionData);
    if (funnelData) updateGA4Funnel(funnelData);
    if (eventsData) updateGA4Events(eventsData);
    if (pagesData) updateGA4Pages(pagesData);
  } catch (error) {
    console.error('Erro ao carregar GA4:', error);
    // Se cache falhar, tentar buscar direto
    loadGA4AnalyticsDirect();
  }
}

// Buscar dados do cache local
async function fetchFromCache(source, metric, days) {
  try {
    const response = await fetch(`/api/sync/cache/${source}/${metric}?days=${days}`);
    if (!response.ok) return null;
    const result = await response.json();
    return result.data;
  } catch {
    return null;
  }
}

// Forcar sync e recarregar (botao Atualizar)
async function forceGA4Sync() {
  try {
    document.getElementById('ga4-funnel-container').innerHTML = '<div style="color: #64748b; text-align: center; padding: 20px;">Sincronizando...</div>';
    await fetch('/api/sync/ga4', { method: 'POST' });
    await loadGA4Analytics();
  } catch (error) {
    console.error('Erro ao sincronizar GA4:', error);
    loadGA4AnalyticsDirect();
  }
}

// Fallback: buscar direto da API GA4 se cache vazio
async function loadGA4AnalyticsDirect() {
  try {
    const token = await getGA4Token();
    if (!token) return;

    const [sessionData, eventsData, pagesData] = await Promise.all([
      fetchGA4SessionMetricsDirect(token),
      fetchGA4EventsDirect(token),
      fetchGA4TopPagesDirect(token)
    ]);

    if (sessionData) updateGA4SessionMetrics(sessionData);
    if (eventsData) updateGA4Events(eventsData);
    if (pagesData) updateGA4Pages(pagesData);
  } catch (error) {
    console.error('Erro ao carregar GA4 direto:', error);
  }
}

async function getGA4Token() {
  try {
    const response = await fetch('/api/ga4/token');
    if (!response.ok) return null;
    const data = await response.json();
    return data.access_token;
  } catch {
    return null;
  }
}

async function fetchGA4SessionMetricsDirect(token) {
  const response = await fetch('https://analyticsdata.googleapis.com/v1beta/properties/518739213:runReport', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      dateRanges: [{ startDate: '7daysAgo', endDate: 'today' }],
      metrics: [
        { name: 'activeUsers' },
        { name: 'sessions' },
        { name: 'screenPageViews' },
        { name: 'bounceRate' }
      ]
    })
  });
  return response.json();
}

async function fetchGA4EventsDirect(token) {
  const response = await fetch('https://analyticsdata.googleapis.com/v1beta/properties/518739213:runReport', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      dateRanges: [{ startDate: '7daysAgo', endDate: 'today' }],
      dimensions: [{ name: 'eventName' }],
      metrics: [{ name: 'eventCount' }],
      limit: 10
    })
  });
  return response.json();
}

async function fetchGA4TopPagesDirect(token) {
  const response = await fetch('https://analyticsdata.googleapis.com/v1beta/properties/518739213:runReport', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      dateRanges: [{ startDate: '7daysAgo', endDate: 'today' }],
      dimensions: [{ name: 'pagePath' }],
      metrics: [{ name: 'screenPageViews' }],
      limit: 8
    })
  });
  return response.json();
}

function updateGA4SessionMetrics(data) {
  if (!data.rows || data.rows.length === 0) return;
  const row = data.rows[0];
  document.getElementById('ga4-active-users').textContent = row.metricValues[0]?.value || '--';
  document.getElementById('ga4-sessions').textContent = row.metricValues[1]?.value || '--';
  document.getElementById('ga4-page-views').textContent = row.metricValues[2]?.value || '--';
  const bounceRate = parseFloat(row.metricValues[3]?.value || 0) * 100;
  document.getElementById('ga4-bounce-rate').textContent = bounceRate.toFixed(1) + '%';
}

function updateGA4Funnel(data) {
  const container = document.getElementById('ga4-funnel-container');
  if (!data.funnelTable?.rows) {
    container.innerHTML = '<div style="color: #64748b; text-align: center;">Sem dados de funil</div>';
    return;
  }

  const maxUsers = Math.max(...data.funnelTable.rows.map(r => parseInt(r.metricValues[0]?.value || 0)));

  container.innerHTML = data.funnelTable.rows.map((row, index) => {
    const stepName = row.dimensionValues[0]?.value || 'Step';
    const users = parseInt(row.metricValues[0]?.value || 0);
    const rate = parseFloat(row.metricValues[1]?.value || 0) * 100;
    const width = maxUsers > 0 ? (users / maxUsers) * 100 : 0;
    const color = index === 0 ? '#3b82f6' : index === data.funnelTable.rows.length - 1 ? '#22c55e' : '#8b5cf6';

    return `
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="width: 140px; font-size: 12px; color: #94a3b8;">${stepName}</div>
        <div style="flex: 1; background: #334155; border-radius: 4px; height: 24px; position: relative; overflow: hidden;">
          <div style="background: ${color}; height: 100%; width: ${width}%; transition: width 0.5s;"></div>
          <div style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 11px; color: white; font-weight: 600;">${users} users</div>
        </div>
        ${index > 0 ? `<div style="width: 60px; font-size: 11px; color: ${rate > 50 ? '#22c55e' : rate > 20 ? '#f59e0b' : '#ef4444'};">${rate.toFixed(1)}%</div>` : '<div style="width: 60px;"></div>'}
      </div>
    `;
  }).join('');
}

function updateGA4Events(data) {
  const container = document.getElementById('ga4-top-events');
  if (!data.rows) {
    container.innerHTML = '<div style="color: #64748b;">Sem eventos</div>';
    return;
  }

  container.innerHTML = data.rows.map(row => {
    const event = row.dimensionValues[0]?.value || '';
    const count = row.metricValues[0]?.value || 0;
    return `
      <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #334155;">
        <span style="color: #e2e8f0;">${event}</span>
        <span style="color: #22c55e; font-weight: 600;">${count}</span>
      </div>
    `;
  }).join('');
}

function updateGA4Pages(data) {
  const container = document.getElementById('ga4-top-pages');
  if (!data.rows) {
    container.innerHTML = '<div style="color: #64748b;">Sem paginas</div>';
    return;
  }

  container.innerHTML = data.rows.map(row => {
    const page = row.dimensionValues[0]?.value || '';
    const views = row.metricValues[0]?.value || 0;
    const shortPage = page.length > 35 ? page.substring(0, 35) + '...' : page;
    return `
      <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #334155;">
        <span style="color: #e2e8f0;" title="${page}">${shortPage}</span>
        <span style="color: #3b82f6; font-weight: 600;">${views}</span>
      </div>
    `;
  }).join('');
}

// Carregar ao iniciar a pagina
document.addEventListener('DOMContentLoaded', function() {
  // Verificar se a pagina de ads-security foi carregada
  setTimeout(loadGA4Analytics, 500);

  // Inicializar colunas redimensionaveis
  setTimeout(initResizableColumns, 100);
});

// =============================================================================
// RESIZABLE TABLE COLUMNS
// =============================================================================
function initResizableColumns() {
  const tables = document.querySelectorAll('.table-resizable');

  tables.forEach(table => {
    const headers = table.querySelectorAll('th');

    headers.forEach((th, index) => {
      // Nao adicionar handle na ultima coluna
      if (index === headers.length - 1) return;

      // Criar handle de resize
      const handle = document.createElement('div');
      handle.className = 'resize-handle';
      th.appendChild(handle);

      let startX, startWidth, isResizing = false;

      handle.addEventListener('mousedown', (e) => {
        e.preventDefault();
        e.stopPropagation();
        isResizing = true;
        startX = e.pageX;
        startWidth = th.offsetWidth;

        handle.classList.add('resizing');
        document.body.classList.add('table-resizing');

        const onMouseMove = (e) => {
          if (!isResizing) return;
          const diff = e.pageX - startX;
          const newWidth = Math.max(50, startWidth + diff);
          th.style.width = newWidth + 'px';
        };

        const onMouseUp = () => {
          isResizing = false;
          handle.classList.remove('resizing');
          document.body.classList.remove('table-resizing');
          document.removeEventListener('mousemove', onMouseMove);
          document.removeEventListener('mouseup', onMouseUp);
        };

        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
    });
  });
}
</script>
