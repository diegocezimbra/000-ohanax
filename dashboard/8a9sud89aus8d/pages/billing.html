<div class="header">
  <h2><span class="service-badge billing">BILLING</span> Billing Service</h2>
  <div class="header-actions">
    <div class="date-filter">
      <select id="billing-period" onchange="onPeriodChange('billing')">
        <option value="7">Ultimos 7 dias</option>
        <option value="30" selected>Ultimos 30 dias</option>
        <option value="90">Ultimos 90 dias</option>
        <option value="365">Ultimo ano</option>
        <option value="custom">Personalizado</option>
      </select>
      <div class="date-range-inputs" id="billing-custom-dates" style="display: none;">
        <input type="date" id="billing-start-date">
        <span>ate</span>
        <input type="date" id="billing-end-date">
      </div>
    </div>
    <button class="refresh-btn" onclick="loadProjectPage('billing')">Atualizar</button>
  </div>
</div>

<div class="cards">
  <div class="card highlight">
    <div class="card-title">MRR Total <span class="info-tooltip" data-tooltip="Monthly Recurring Revenue - Receita mensal recorrente do Billing Service. Soma de todas as assinaturas ativas."></span></div>
    <div class="card-value" id="billing-mrr">R$ --</div>
    <div class="card-subtitle">Receita mensal recorrente</div>
  </div>
  <div class="card">
    <div class="card-title">Receita One-Time <span class="info-tooltip" data-tooltip="Receita de vendas unicas de pacotes avulsos do Billing. Pagamentos unicos sem recorrencia."></span></div>
    <div class="card-value" id="billing-onetime-revenue">R$ --</div>
    <div class="card-subtitle">Pacotes vendidos</div>
  </div>
  <div class="card">
    <div class="card-title">Receita Total <span class="info-tooltip" data-tooltip="Soma total de receita do Billing: MRR (assinaturas) + One-Time (pacotes avulsos)."></span></div>
    <div class="card-value" id="billing-total-revenue">R$ --</div>
    <div class="card-subtitle">MRR + One-Time</div>
  </div>
  <div class="card">
    <div class="card-title">Usuarios Total <span class="info-tooltip tooltip-left" data-tooltip="Total de usuarios cadastrados no Billing Service. Inclui todos os status."></span></div>
    <div class="card-value" id="billing-users">--</div>
    <div class="card-subtitle">Usuarios registrados</div>
  </div>
</div>

<div class="cards" style="margin-top: -10px;">
  <div class="card">
    <div class="card-title">ARR Total <span class="info-tooltip" data-tooltip="Annual Recurring Revenue - MRR x 12. Projecao anual da receita recorrente."></span></div>
    <div class="card-value" id="billing-arr">R$ --</div>
    <div class="card-subtitle">Receita anual recorrente</div>
  </div>
  <div class="card">
    <div class="card-title">Assinantes Ativos <span class="info-tooltip" data-tooltip="Clientes com assinatura ativa pagando mensalmente pelo Billing Service."></span></div>
    <div class="card-value" id="billing-subs">--</div>
    <div class="card-subtitle">Assinantes pagantes</div>
  </div>
  <div class="card">
    <div class="card-title">Pacotes Vendidos <span class="info-tooltip" data-tooltip="Total de pacotes avulsos vendidos no Billing. Cada compra conta como uma unidade."></span></div>
    <div class="card-value" id="billing-onetime-count">--</div>
    <div class="card-subtitle">One-time pagos</div>
  </div>
  <div class="card">
    <div class="card-title">Clientes Unicos <span class="info-tooltip tooltip-left" data-tooltip="Clientes unicos que pagaram pelo Billing (assinatura ou one-time). Cada email conta uma vez."></span></div>
    <div class="card-value" id="billing-unique-customers">--</div>
    <div class="card-subtitle">Assinantes + Compradores</div>
  </div>
</div>

<div class="grid-2">
  <div class="section">
    <div class="section-title">Usuarios <span class="info-tooltip" data-tooltip="Metricas de usuarios do Billing Service. Mostra diferentes segmentacoes da base."></span></div>
    <div class="metric-row">
      <span class="metric-label">Total <span class="info-tooltip" data-tooltip="Todos os usuarios cadastrados no Billing, independente de status."></span></span>
      <span class="metric-value" id="billing-users-total">--</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Verificados <span class="info-tooltip" data-tooltip="Usuarios que confirmaram o email."></span></span>
      <span class="metric-value" id="billing-users-verified">--</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Ativos (7d) <span class="info-tooltip" data-tooltip="Usuarios que fizeram login nos ultimos 7 dias."></span></span>
      <span class="metric-value" id="billing-users-active">--</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Novos hoje <span class="info-tooltip" data-tooltip="Usuarios cadastrados hoje."></span></span>
      <span class="metric-value" id="billing-users-today">--</span>
    </div>
  </div>
  <div class="section">
    <div class="section-title">Assinaturas <span class="info-tooltip" data-tooltip="Metricas de assinaturas do Billing Service."></span></div>
    <div class="metric-row">
      <span class="metric-label">Ativos <span class="info-tooltip" data-tooltip="Assinaturas com status 'active' - pagando mensalmente."></span></span>
      <span class="metric-value" id="billing-subs-active">--</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Em Trial <span class="info-tooltip" data-tooltip="Usuarios em periodo de teste gratuito."></span></span>
      <span class="metric-value" id="billing-subs-trial">--</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Cancelados <span class="info-tooltip" data-tooltip="Assinaturas canceladas (churn)."></span></span>
      <span class="metric-value" id="billing-subs-canceled">--</span>
    </div>
    <div class="metric-row">
      <span class="metric-label">Receita Total <span class="info-tooltip" data-tooltip="Soma de toda receita de assinaturas."></span></span>
      <span class="metric-value" id="billing-revenue">R$ --</span>
    </div>
  </div>
</div>

<div class="section">
  <div class="section-title">Funil de Conversao - Billing (90 dias) <span class="info-tooltip" data-tooltip="Jornada do usuario no Billing: visitante -> cadastro -> trial -> pagante. Dados dos ultimos 90 dias."></span></div>
  <div class="funnel-grid">
    <div class="funnel-chart-container">
      <div id="billing-funnel-chart"></div>
    </div>
    <div class="funnel-stats">
      <div class="funnel-stat-card">
        <div class="funnel-stat-icon visitor"></div>
        <div class="funnel-stat-info">
          <div class="funnel-stat-value" id="billing-funnel-visitors">--</div>
          <div class="funnel-stat-label">Visitantes <span class="info-tooltip" data-tooltip="Visitantes unicos no site do Billing. Via Umami Analytics."></span></div>
        </div>
      </div>
      <div class="funnel-stat-card">
        <div class="funnel-stat-icon registered"></div>
        <div class="funnel-stat-info">
          <div class="funnel-stat-value" id="billing-funnel-registered">--</div>
          <div class="funnel-stat-label">Cadastrados <span class="info-tooltip" data-tooltip="Usuarios que criaram conta."></span></div>
          <div class="funnel-stat-percent" id="billing-funnel-reg-percent">--% dos visitantes</div>
        </div>
      </div>
      <div class="funnel-stat-card">
        <div class="funnel-stat-icon trial"></div>
        <div class="funnel-stat-info">
          <div class="funnel-stat-value" id="billing-funnel-trial">--</div>
          <div class="funnel-stat-label">Em Trial <span class="info-tooltip" data-tooltip="Cadastrados que iniciaram trial."></span></div>
          <div class="funnel-stat-percent" id="billing-funnel-trial-percent">--% dos cadastros</div>
        </div>
      </div>
      <div class="funnel-stat-card highlight">
        <div class="funnel-stat-icon paying"></div>
        <div class="funnel-stat-info">
          <div class="funnel-stat-value" id="billing-funnel-paying">--</div>
          <div class="funnel-stat-label">Pagantes <span class="info-tooltip" data-tooltip="Clientes pagantes - metrica principal."></span></div>
          <div class="funnel-stat-percent" id="billing-funnel-paying-percent">--% total</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="section">
  <div class="section-title">Crescimento de Usuarios <span class="info-tooltip" data-tooltip="Evolucao de novos cadastros ao longo do tempo no Billing Service."></span></div>
  <div id="billingChart" style="height: 250px;"></div>
</div>

<div class="section">
  <div class="section-title">Assinantes Recentes <span class="info-tooltip" data-tooltip="Lista das assinaturas mais recentes do Billing Service."></span></div>
  <table>
    <thead>
      <tr><th>Email</th><th>Plano</th><th>MRR</th><th>Status</th><th>Data</th></tr>
    </thead>
    <tbody id="billing-table"><tr><td colspan="5" class="loading">Carregando...</td></tr></tbody>
  </table>
</div>

<!-- Seção de Auditoria & Atividades -->
<div class="section">
  <div class="section-title">Auditoria & Atividades <span class="info-tooltip" data-tooltip="Registro de todas as acoes administrativas e atividades do sistema. Importante para compliance e rastreabilidade."></span></div>
  <div class="audit-summary-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
    <div class="audit-card" style="background: var(--card-bg, #1e293b); border-radius: 8px; padding: 16px; border: 1px solid var(--border-color, #334155);">
      <div style="font-size: 12px; color: var(--text-muted, #94a3b8); margin-bottom: 4px;">Total de Acoes (7d) <span class="info-tooltip" data-tooltip="Total de acoes registradas nos ultimos 7 dias. Inclui todas as operacoes do sistema."></span></div>
      <div id="billing-audit-total" style="font-size: 24px; font-weight: bold; color: var(--text-primary, #f1f5f9);">--</div>
    </div>
    <div class="audit-card" style="background: var(--card-bg, #1e293b); border-radius: 8px; padding: 16px; border: 1px solid var(--border-color, #334155);">
      <div style="font-size: 12px; color: var(--text-muted, #94a3b8); margin-bottom: 4px;">Acoes Criticas (7d) <span class="info-tooltip" data-tooltip="Acoes de alto impacto como delecoes, alteracoes de permissao, etc. Requerem atencao especial."></span></div>
      <div id="billing-audit-critical-count" style="font-size: 24px; font-weight: bold; color: #ef4444;">--</div>
    </div>
    <div class="audit-card" style="background: var(--card-bg, #1e293b); border-radius: 8px; padding: 16px; border: 1px solid var(--border-color, #334155);">
      <div style="font-size: 12px; color: var(--text-muted, #94a3b8); margin-bottom: 4px;">Admins Ativos (7d) <span class="info-tooltip" data-tooltip="Quantidade de administradores que realizaram acoes nos ultimos 7 dias."></span></div>
      <div id="billing-audit-admins" style="font-size: 24px; font-weight: bold; color: var(--text-primary, #f1f5f9);">--</div>
    </div>
  </div>
</div>

<div class="grid-2">
  <div class="section">
    <div class="section-title">Atividade por Dia <span class="info-tooltip" data-tooltip="Grafico de acoes de auditoria por dia. Ajuda a identificar picos de atividade."></span></div>
    <div id="billing-audit-chart" style="height: 200px;"></div>
  </div>
  <div class="section">
    <div class="section-title">Resumo por Tipo de Acao <span class="info-tooltip" data-tooltip="Distribuicao de acoes por tipo (criar, editar, deletar, etc). Mostra padrao de uso do sistema."></span></div>
    <div id="billing-audit-by-action">
      <div style="color: var(--text-muted, #94a3b8);">Carregando...</div>
    </div>
  </div>
</div>

<div class="grid-2">
  <div class="section">
    <div class="section-title" style="display: flex; align-items: center; gap: 8px;">
      <span style="width: 8px; height: 8px; background: #ef4444; border-radius: 50%;"></span>
      Acoes Criticas Recentes <span class="info-tooltip" data-tooltip="Ultimas acoes criticas realizadas. Acoes criticas podem impactar dados ou seguranca."></span>
    </div>
    <div id="billing-critical-actions">
      <div style="color: var(--text-muted, #94a3b8);">Carregando...</div>
    </div>
  </div>
  <div class="section">
    <div class="section-title">Sessoes de Admin <span class="info-tooltip" data-tooltip="Sessoes ativas de administradores. Mostra quem esta logado como admin."></span></div>
    <div id="billing-admin-sessions">
      <div style="color: var(--text-muted, #94a3b8);">Carregando...</div>
    </div>
  </div>
</div>

<div class="section">
  <div class="section-title">Atividades Recentes <span class="info-tooltip" data-tooltip="Log detalhado das ultimas atividades. Mostra admin, acao, recurso afetado e detalhes."></span></div>
  <table>
    <thead>
      <tr><th>Data</th><th>Admin</th><th>Acao</th><th>Recurso</th><th>Detalhes</th></tr>
    </thead>
    <tbody id="billing-audit-table"><tr><td colspan="5" class="loading">Carregando...</td></tr></tbody>
  </table>
</div>
