<div class="header">
  <h2>Dashboard Overview</h2>
  <div class="header-actions">
    <div class="date-filter">
      <select id="overview-period" onchange="onPeriodChange('overview')">
        <option value="7">Ultimos 7 dias</option>
        <option value="30" selected>Ultimos 30 dias</option>
        <option value="90">Ultimos 90 dias</option>
        <option value="365">Ultimo ano</option>
        <option value="custom">Personalizado</option>
      </select>
      <div class="date-range-inputs" id="overview-custom-dates" style="display: none;">
        <input type="date" id="overview-start-date">
        <span>ate</span>
        <input type="date" id="overview-end-date">
      </div>
    </div>
    <button class="refresh-btn" onclick="loadAllData()">Atualizar</button>
  </div>
</div>

<div class="cards">
  <div class="card highlight">
    <div class="card-title">MRR Total</div>
    <div class="card-value" id="total-mrr">R$ --</div>
    <div class="card-subtitle">Receita mensal recorrente</div>
  </div>
  <div class="card">
    <div class="card-title">Receita One-Time</div>
    <div class="card-value" id="total-onetime">R$ --</div>
    <div class="card-subtitle">Pacotes vendidos</div>
  </div>
  <div class="card">
    <div class="card-title">Receita Total</div>
    <div class="card-value" id="total-revenue">R$ --</div>
    <div class="card-subtitle">MRR + One-Time</div>
  </div>
  <div class="card">
    <div class="card-title">Usuarios Total</div>
    <div class="card-value" id="total-users">--</div>
    <div class="card-subtitle">Todos os servicos</div>
  </div>
</div>

<div class="cards" style="margin-top: -10px;">
  <div class="card">
    <div class="card-title">ARR Total</div>
    <div class="card-value" id="total-arr">R$ --</div>
    <div class="card-subtitle">Receita anual recorrente</div>
  </div>
  <div class="card">
    <div class="card-title">Assinantes Ativos</div>
    <div class="card-value" id="active-subs">--</div>
    <div class="card-subtitle">Assinantes pagantes</div>
  </div>
  <div class="card">
    <div class="card-title">Pacotes Vendidos</div>
    <div class="card-value" id="total-purchases">--</div>
    <div class="card-subtitle">One-time pagos</div>
  </div>
  <div class="card">
    <div class="card-title">Clientes Unicos</div>
    <div class="card-value" id="total-customers">--</div>
    <div class="card-subtitle">Assinantes + Compradores</div>
  </div>
</div>

<div class="section">
  <div class="section-title">Funil de Conversao</div>
  <div class="funnel-wrapper">
    <div class="funnel-container">
      <div class="funnel-chart" id="funnel-visual">
        <!-- Stage 1: Cadastrados (100% width) -->
        <div class="funnel-stage">
          <div class="funnel-trapezoid registered" style="width: 100%; --top-left: 0%; --top-right: 100%; --bottom-left: 10%; --bottom-right: 90%;">
            <div class="funnel-stage-content">
              <div class="funnel-stage-left">
                <span class="funnel-stage-label">Cadastrados</span>
                <span class="funnel-stage-count" id="funnel-count-registered">--</span>
              </div>
              <div class="funnel-stage-right">
                <span class="funnel-stage-percent">100%</span>
              </div>
            </div>
          </div>
        </div>
        <div class="funnel-arrow"></div>
        <!-- Stage 2: Em Trial -->
        <div class="funnel-stage">
          <div class="funnel-trapezoid trial" id="funnel-bar-trial" style="width: 80%; --top-left: 0%; --top-right: 100%; --bottom-left: 10%; --bottom-right: 90%;">
            <div class="funnel-stage-content">
              <div class="funnel-stage-left">
                <span class="funnel-stage-label">Em Trial</span>
                <span class="funnel-stage-count" id="funnel-count-trial">--</span>
              </div>
              <div class="funnel-stage-right">
                <span class="funnel-stage-percent" id="funnel-percent-trial">--%</span>
                <span class="funnel-stage-conversion">do cadastro</span>
              </div>
            </div>
          </div>
        </div>
        <div class="funnel-arrow"></div>
        <!-- Stage 3: Pagantes -->
        <div class="funnel-stage">
          <div class="funnel-trapezoid paying" id="funnel-bar-paying" style="width: 40%; --top-left: 0%; --top-right: 100%; --bottom-left: 15%; --bottom-right: 85%;">
            <div class="funnel-stage-content">
              <div class="funnel-stage-left">
                <span class="funnel-stage-label">Pagantes</span>
                <span class="funnel-stage-count" id="funnel-count-paying">--</span>
              </div>
              <div class="funnel-stage-right">
                <span class="funnel-stage-percent" id="funnel-percent-paying">--%</span>
                <span class="funnel-stage-conversion">do cadastro</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="funnel-metrics">
        <div class="funnel-metric">
          <span class="funnel-metric-value" id="funnel-conversion-reg-trial">--%</span>
          <span class="funnel-metric-label">Cadastro → Trial</span>
        </div>
        <div class="funnel-metric">
          <span class="funnel-metric-value" id="funnel-conversion-trial">--%</span>
          <span class="funnel-metric-label">Trial → Pagante</span>
        </div>
        <div class="funnel-metric">
          <span class="funnel-metric-value" id="funnel-conversion-total">--%</span>
          <span class="funnel-metric-label">Cadastro → Pagante</span>
        </div>
      </div>
    </div>
    <!-- Total conversion summary -->
    <div class="funnel-total">
      <div class="funnel-total-item">
        <div class="funnel-total-value" id="funnel-total-registered">--</div>
        <div class="funnel-total-label">Cadastros Totais</div>
      </div>
      <div class="funnel-total-divider"></div>
      <div class="funnel-total-item">
        <div class="funnel-total-value" id="funnel-total-paying">--</div>
        <div class="funnel-total-label">Clientes Pagantes</div>
      </div>
      <div class="funnel-total-divider"></div>
      <div class="funnel-total-item">
        <div class="funnel-total-value" id="funnel-total-conversion">--%</div>
        <div class="funnel-total-label">Conversao Total</div>
      </div>
    </div>
  </div>
</div>

<div class="grid-2">
  <div class="section">
    <div class="section-title">Usuarios por Projeto</div>
    <div id="overview-users-project"><div class="loading">Carregando...</div></div>
  </div>
  <div class="section">
    <div class="section-title">MRR por Projeto</div>
    <div id="overview-mrr-project"><div class="loading">Carregando...</div></div>
  </div>
</div>

<div class="section">
  <div class="section-title">Pacotes One-Time por Projeto</div>
  <div id="overview-onetime-project"><div class="loading">Carregando...</div></div>
</div>

<div class="section">
  <div class="section-title">MRR por Projeto</div>
  <div class="chart-container"><canvas id="overviewChart"></canvas></div>
</div>

<div class="section">
  <div class="section-title">Ultimos Assinantes</div>
  <table>
    <thead>
      <tr><th>Email</th><th>Plano</th><th>Projeto</th><th>MRR</th><th>Status</th></tr>
    </thead>
    <tbody id="overview-subscribers-table"><tr><td colspan="5" class="loading">Carregando...</td></tr></tbody>
  </table>
</div>
